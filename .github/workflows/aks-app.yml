name: Build and Deploy to AKS

on:
  push:
    branches:
      - main
      - develop

env:
  ACR_NAME: acrskhan
  ACR_LOGIN_SERVER: acrskhan.azurecr.io
  IMAGE_NAME: skhan-app
  AKS_CLUSTER: skhanaks
  AKS_RG: rg-skhan-aks
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Azure CLI Login using service principal
      - name: Azure CLI Login
        run: |
          echo '${{ secrets.AZURE_CREDENTIALS }}' > azure-credentials.json
          CLIENT_ID=$(jq -r .clientId azure-credentials.json)
          CLIENT_SECRET=$(jq -r .clientSecret azure-credentials.json)
          TENANT_ID=$(jq -r .tenantId azure-credentials.json)
          az login --service-principal -u $CLIENT_ID -p $CLIENT_SECRET --tenant $TENANT_ID
          az account set --subscription $(jq -r .subscriptionId azure-credentials.json)

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push image to ACR
        uses: docker/build-push-action@v4
        with:
          context: ./app1
          file: ./app1/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name: Configure kubectl context for AKS
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RG }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Attach ACR to AKS (if not already)
        run: az aks update -n ${{ env.AKS_CLUSTER }} -g ${{ env.AKS_RG }} --attach-acr ${{ env.ACR_NAME }} || true

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install/upgrade NGINX Ingress Controller with Helm
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update
          helm upgrade --install nginx-ingress ingress-nginx/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --wait

      - name: Create TLS secret from cert files
        run: |
          kubectl create secret tls skhan-tls \
            --cert=./cert/skhan.tech.crt \
            --key=./cert/skhan.tech.key \
            -n default --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy application (Deployment + Service) with Helm
        run: |
          helm upgrade --install skhan-app ./charts/skhan-app \
            --namespace default --create-namespace \
            --set image.repository=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --wait

      - name: Deploy Ingress with Helm (Ingress + TLS)
        run: |
          helm upgrade --install skhan-ingress ./charts/skhan-ingress \
            --namespace default \
            --set host=skhan.tech \
            --set serviceName=default-skhan-svc-80 \
            --set servicePort=80 \
            --set tls.secretName=skhan-tls \
            --wait
